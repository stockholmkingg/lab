# Организация безопасности сети
## Rate Limit
### Вводная
Сервер nginx достаточно часто используется не только как веб-сервер, но и как reverse proxy. Что это значит? Это значит, что его ставят перед тяжёлыми веб-приложениями и позволяют ему решать следующие задачи:

Отдавать "статику" (статичные файлы, с чем он справляется достаточно хорошо)

Проксировать запросы на Upstream сервера (т.е. запрос приходит на nginx, nginx его отправляет дальше на сервер с приложением)

Зачем нужна вторая функция? nginx может взять на себя задачи по работе с медленными клиентами, кэшированию и т.д.

А кроме того, может служить программным балансировщиком нагрузки и лимитировать поток входящих запросов (именно это нас и будет интересовать).

Что мы хотим сделать? Мы хотим научиться с помощью nginx ограничивать поток входящих запросов с одного ip-адреса.

Описание выполнения
У вас должно быть две виртуальные машины:

- Ubuntu с nginx (192.168.0.1)
- Kali (192.168.0.2)
### Без лимита
Ubuntu
1. Удостоверяетесь, что сервис nginx запущен, порт 80 открыт.

2. Если вы не устанавливали nginx, то:
```
sudo apt update
sudo apt install nginx
```
3. Редактируете конфигурацию <code>sudo mcedit /etc/nginx/sites-enabled/default</code>, чтобы она выглядела следующим образом:
![OSNscheme.png](..%2F..%2Fimages%2FOSNscheme.png)
4. Сохраняете изменения

5. Проверяете корректность конфигурации <code>sudo nginx -t</code>

6. Применяете конфигурацию <code>sudo nginx -s reload</code>

Kali
Для генерации запросов мы будем использовать утилиту Apache Benchmarks.
```
ab --help
```
Далее сделаем 1000 запросов по 100 запросов одновременно:
```
ab -n 1000 -c 100 http://netology.local/
```
Удостоверяемся, что все запросы проходят
### Rate Limit
Ubuntu

Меняем настройки nginx:
```
sudo mcedit /etc/nginx/sites-enabled/default.conf
```
Редактируем конфигурацию, чтобы она выглядела следующим образом:
![OSNscheme.v2.png](..%2F..%2Fimages%2FOSNscheme.v2.png)
Тестируем конфигурацию и применяем изменения:
```
sudo nginx -t
sudo nginx -s reload
```
Kali
Ещё раз делаем 1000 запросов по 100 запросов одновременно:
```
ab -n 1000 -c 100 http://netology.local/
```
Удостоверяемся, что часть из них завершается с ошибкой:
![OSNscheme.v3.png](..%2F..%2Fimages%2FOSNscheme.v3.png)
### Fail2Ban (необязательная часть)
Конечно же, можно пойти дальше и "блочить" IP, в этом нам поможет Fail2Ban, который мы рассмотрели на лекции

Ubuntu
```
sudo apt update
sudo apt install fail2ban
```
Удостоверяемся, что сервис запущен:
```
systemctl status fail2ban
```
![OSNscheme.v4.png](..%2F..%2Fimages%2FOSNscheme.v4.png)
```
sudo cp /etc/fail2ban/jail.conf /etc/fail2ban/jail.local
sudo mcedit /etc/fail2ban/jail.local
```
Спускаетесь до записи <code>[nginx-limit-req]</code> и включаете её добавлением строки <code>enabled = true</code>:
![OSNscheme.v5.png](..%2F..%2Fimages%2FOSNscheme.v5.png)
Сохраняете файл и применяете конфигурацию:
```
sudo fail2ban-server reload
sudo fail2ban-server status
```
![OSNscheme.v6.png](..%2F..%2Fimages%2FOSNscheme.v6.png)
Kali
Убедитесь, что после пары запусков <code>ab</code> вас "забанят":
![OSNscheme.v7.png](..%2F..%2Fimages%2FOSNscheme.v7.png)
Удостоверяемся, что адрес Kali действительно забанен:
```
sudo zgrep 'Ban' /var/log/fail2ban.log
```
### Результат
Пришлите следующие скриншоты:

1. Скриншот с запросами ab до включения limit_req на nginx
2. Скриншот с запросами ab после включения limit_req на nginx
3. Скриншот с запросами ab после включения fail2ban (не обязательно)

## Suricata*
### Вводная
Мы уже посмотрели, как настраивать Suricata на лекции. Сейчас стоит задача выяснить, как она по умолчанию реагирует на попытки DoS'а (например, с помощью ab).

### Задача
1. Настройте suricata согласно материалам из лекций
2. Отключите fail2ban, если он у вас был включен
3. Уберите из nginx rate limit
4. Проведите с машины с Kali с помощью ab в трёх вариантах (последовательно):
   - 10_000 запросов по 100 одновременно
   - 10_000 запросов по 1000 одновременно 
   - 10_000 запросов по 10 одновременно

В качестве ответа пришлите описание реакции Suricata на подобное воздействие.
## Suricata Rules*
Если вы ставили nginx по умолчанию, так, как описано в ДЗ, то в логах suricata обнаружите запись:
```
ET INFO Unconfigured nginx Access
```
Правила, которые мы использовали в предыдущем ДЗ, располагаются в файле <code>/var/lib/suricata/rules/suricata.rules</code>.

Найдите, среди правил правило, которое отвечает за эту строку и кратко опишите:
1. На основании чего происходит срабатывание данного правила
2. Ваше предположение о том, на что оно направлено